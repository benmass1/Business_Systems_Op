{% extends "layout.html" %}
{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-white fw-bold mb-0"><i class="fas fa-store me-2 text-warning"></i>{{ shop.shop_name }}</h2>
            <p class="text-secondary small mb-0">{{ shop.shop_slogan }}</p>
        </div>
        <div class="text-end">
            <span class="badge bg-dark text-warning p-2 border border-warning shadow-sm">
                <i class="far fa-clock me-1"></i> {{ datetime_now }}
            </span>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="luxury-card p-3 shadow-sm border-start border-warning border-4 h-100">
                <small class="text-secondary d-block fw-bold">MAUZO YA LEO</small>
                <h3 class="text-white fw-bold mt-1">Tsh {{ "{:,.0f}".format(total_sales) }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="luxury-card p-3 shadow-sm border-start border-success border-4 h-100">
                <small class="text-secondary d-block fw-bold">FAIDA YA LEO</small>
                <h3 class="text-success fw-bold mt-1">Tsh {{ "{:,.0f}".format(total_profit) }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="luxury-card p-3 shadow-sm border-start border-danger border-4 h-100">
                <small class="text-secondary d-block fw-bold">PUNGUZO LEO</small>
                <h3 class="text-danger fw-bold mt-1">Tsh {{ "{:,.0f}".format(total_discount or 0) }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="luxury-card p-3 shadow-sm border-start border-info border-4 h-100">
                <small class="text-secondary d-block fw-bold">STOO INAYOISHA</small>
                <h3 class="text-info fw-bold mt-1">{{ low_stock }} <small class="fs-6 text-muted text-uppercase">Items</small></h3>
            </div>
        </div>
    </div>

    <div class="luxury-card p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="text-white mb-0"><i class="fas fa-shopping-cart me-2 text-warning"></i>Fanya Mauzo</h4>
            <div class="text-muted small">Mteja akitaka bidhaa nyingi, weka idadi hapa chini</div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle">
                <thead>
                    <tr class="text-secondary border-bottom border-secondary">
                        <th>BIDHAA</th>
                        <th>BEI (UNIT)</th>
                        <th>STOO</th>
                        <th style="width: 120px;">IDADI</th>
                        <th style="width: 150px;">PUNGUZO</th>
                        <th class="text-center">JUMLA KUU</th>
                        <th class="text-end">KITENDO</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in products %}
                    <tr>
                        <td>
                            <div class="fw-bold text-warning">{{ p.name }}</div>
                            <small class="text-muted small">Ref: #00{{ p.id }}</small>
                        </td>
                        <td class="text-white fw-semibold">{{ "{:,.0f}".format(p.selling_price) }}</td>
                        <td>
                            {% if p.stock <= 5 %}
                                <span class="badge bg-soft-danger text-danger border border-danger p-2 w-100">Inaisha: {{ p.stock }}</span>
                            {% else %}
                                <span class="badge bg-soft-secondary text-white border border-secondary p-2 w-100">{{ p.stock }} Ipo</span>
                            {% endif %}
                        </td>
                        
                        <form action="{{ url_for('sell', id=p.id) }}" method="POST">
                            <td>
                                <input type="number" name="quantity" id="qty-{{ p.id }}" 
                                       class="form-control form-control-sm bg-dark text-white border-secondary" 
                                       value="1" min="1" max="{{ p.stock }}" 
                                       oninput="updateRowTotal({{ p.id }}, {{ p.selling_price }})" required>
                            </td>
                            <td>
                                <div class="input-group input-group-sm">
                                    <input type="number" name="discount" id="disc-{{ p.id }}" 
                                           class="form-control bg-dark text-white border-secondary" 
                                           value="0" min="0" 
                                           oninput="updateRowTotal({{ p.id }}, {{ p.selling_price }})">
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="text-success fw-bold" id="total-{{ p.id }}">
                                    {{ "{:,.0f}".format(p.selling_price) }}
                                </span>
                            </td>
                            <td class="text-end">
                                <button type="submit" class="btn btn-warning btn-sm px-4 rounded-pill fw-bold text-dark shadow-sm"
                                        {% if p.stock <= 0 %}disabled{% endif %}>
                                    <i class="fas fa-cash-register me-1"></i> UZA
                                </button>
                            </td>
                        </form>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function updateRowTotal(id, price) {
    let qty = document.getElementById('qty-' + id).value || 0;
    let disc = document.getElementById('disc-' + id).value || 0;
    let total = (price * qty) - disc;
    
    // Inazuia jumla kuwa hasi (negative)
    if (total < 0) total = 0;
    
    document.getElementById('total-' + id).innerText = total.toLocaleString();
}
</script>

<style>
    body { background-color: #0a0a0a; color: #e0e0e0; }
    .luxury-card {
        background: #151515;
        border-radius: 12px;
        border: 1px solid #282828;
    }
    .table-dark { background-color: transparent !important; }
    .bg-soft-danger { background-color: rgba(220, 53, 69, 0.1); }
    .bg-soft-secondary { background-color: rgba(108, 117, 125, 0.1); }
    .form-control:focus {
        background-color: #1a1a1a;
        border-color: #ffc107;
        color: white;
        box-shadow: none;
    }
    .btn-warning:hover { background-color: #e5ac00; transform: translateY(-1px); }
</style>
{% endblock %}

